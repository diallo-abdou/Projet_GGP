---
title: "Projet_GGP"
author: "Abdou, Antoine et Youna"
date: "2023-11-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

packages <- c("coala","ape","ggplot2")
A <- lapply(
  packages,
  FUN = function(x) {
    if (!require(x, character.only = TRUE)) {
      install.packages(x, dependencies = TRUE)
      library(x, character.only = TRUE)
    }
  }
)
```

# Plan












# Effet d'un changement de la taille de la population

Pour modifier la démographie, nous devons utiliser la fonction \textit{feat_size_change} qui nécessite deux paramètres : la taille de la population ancestrale donnée comme une fraction de la taille de la population actuelle, $N_0$ et le temps (dans le passé) auquel la population est modifiée. Le temps est compté en $2N_0$ générations.
Nous supposons que le taux de mutation par site est $u=10^{-8}$ ***(plutot, $u = 1$)***. Nous simulons 10 individus séquencés à 1000 loci, chaque loci ayant une longueur de 1000 pb.


1) Réglez les paramètres NPAST, TCHANGE et THETA pour simuler les scénarios suivants :


## Scénario 1

- Une population ancestrale de taille $N_{anc}=10000$ qui passe à $N_0=50000$ 10000 générations dans le passé.

### NPAST

 
Dans le contexte du scénario 1, le facteur de changement de taille de population est :

$$\text{Facteur de changement} = \frac{N_{anc}}{N_{0}} $$

Dans ce scénario :

$$ \text{Facteur de changement} = \frac{10,000}{50,000} = 0.2 $$

### TCHANGE
Calculons `TCHANGE` dans le scénario où la taille de la population ancestrale passe de $N_{anc} = 10,000$ à $N_0 = 50,000$ sur 10,000 générations passées :

$$ TCHANGE = \frac{\text{Nombre de générations passées}}{2N_0} $$

Dans le scénario 1 :
$$ TCHANGE = \frac{10,000}{2 \times 50,000} = 0.1 $$

Ainsi, `TCHANGE` est égal à $0.1$, indiquant que le changement de taille de population s'est produit il y a $0.1$ unité de $2N_0$ générations (ou 10,000 générations) dans le passé. 


```{r}
# Default values corresponds to scenarios 1

NPAST <- 0.2 # Nanc/N0
TCHANGE <- 10000/(2*50000) # 
THETA <- 1

model <- coal_model(sample_size = 100,loci_number = 1000,loci_length = 1000,ploidy = 2)
model <- model <- model + feat_mutation(rate = THETA)
model <- model + feat_size_change(new_size = NPAST,time = TCHANGE,population = "all")
model <- model +
  sumstat_tajimas_d(name = "Dtaj") +
  sumstat_nucleotide_div(name = "pi") +
  sumstat_sfs(name="sfs") +
  sumstat_trees(name="trees")
sim <- simulate(model)

mean_pi <- mean(sim$pi)
se_pi <- sd(sim$pi)/sqrt(NLOCI)
mean_Dtaj <- mean(sim$Dtaj,na.rm = T) # Dtaj is not defined if there is no SNPs
se_Dtaj <- var(sim$Dtaj,na.rm = T)/sqrt(NLOCI)


obs <- data.frame(mean_pi = mean(sim$pi), 
                 se_pi = sd(sim$pi)/sqrt(NLOCI), 
                 mean_Dtaj = mean(sim$Dtaj,na.rm = T), 
                 se_Dtaj = var(sim$Dtaj,na.rm = T)/sqrt(NLOCI))

layout(matrix(c(1:4),2,2))
hist(sim$pi,main=paste("Mean pi =",round(mean_pi,2)," +/- ",round(1.96*se_pi,2)),breaks=30)
hist(sim$Dtaj,main=paste("Mean Dtaj =",round(mean_Dtaj,2),"+/-",round(1.96*se_Dtaj,2)),breaks=30)
barplot(sim$sfs, main="SFS")
tr <- read.tree(text = sim$trees[[1]][[1]])
plot(tr,main="Example of a genealogy")

plot(density(sim$Dtaj, na.rm = TRUE), 
      main = "Distribution of Tajiam's D")
```






## Scénario 2

- Une population ancestrale de taille $N_{anc}=200000$ qui chute à $N_0=50000$ 50000 générations dans le passé.

### NPAST

Dans le contexte du scénario 2, le facteur de changement de taille de population est :

$$\text{Facteur de changement} = \frac{N_{anc}}{N_{0}} $$

Dans ce scénario :

$$ \text{Facteur de changement} = \frac{200000}{50 000} = 4 $$

### TCHANGE

Calculons `TCHANGE` dans le scénario où la taille de la population ancestrale chute de $N_{anc} = 200,000$ à $N_0 = 50,000$ sur 50,000 générations passées, vous devez utiliser la formule fournie dans votre question originale. Le temps du changement (`TCHANGE`) est mesuré en unités de $2N_0$ générations.


$$ TCHANGE = \frac{\text{Nombre de générations passées}}{2N_0} $$

Dans ce scénario :
$$ TCHANGE = \frac{50,000}{2 \times 50,000} = 0.5 $$

Ainsi, `TCHANGE` est égal à 0.5, ce qui indique que le changement de taille de population s'est produit il y a 0.5 unité de $2N_0$ générations (ou 50,000 générations).



```{r}
# Default values corresponds to scenarios 2

NPAST <- 4
TCHANGE <- 50000/(2*50000)
THETA <- 1

model <- coal_model(sample_size = 100,loci_number = 1000,loci_length = 1000,ploidy = 2)
model <- model <- model + feat_mutation(rate = THETA)
model <- model + feat_size_change(new_size = NPAST,time = TCHANGE,population = "all")
model <- model +
  sumstat_tajimas_d(name = "Dtaj") +
  sumstat_nucleotide_div(name = "pi") +
  sumstat_sfs(name="sfs") +
  sumstat_trees(name="trees")
sim <- simulate(model)



mean_pi <- mean(sim$pi)
se_pi <- sd(sim$pi)/sqrt(NLOCI)
mean_Dtaj <- mean(sim$Dtaj,na.rm = T) # Dtaj is not defined if there is no SNPs
se_Dtaj <- var(sim$Dtaj,na.rm = T)/sqrt(NLOCI)

layout(matrix(c(1:4),2,2))
hist(sim$pi,main=paste("Mean pi =",round(mean_pi,2)," +/- ",round(1.96*se_pi,2)),breaks=30)
hist(sim$Dtaj,main=paste("Mean Dtaj =",round(mean_Dtaj,2),"+/-",round(1.96*se_Dtaj,2)),breaks=30)
barplot(sim$sfs, main="SFS")
tr <- read.tree(text = sim$trees[[1]][[1]])
plot(tr,main="Example of a genealogy")

plot(density(sim$Dtaj, na.rm = TRUE), 
      main = "Distribution of Tajiam's D")
```



2) Run the model and interpret the results

3) Additional question: write the code to compare the SFS under the two demographic scenarios and the constant population size secnario.


# ABC avec Scénario 1

```{r}

# Install and load the optimx package
library(deSolve)
library(ggplot2)
library(optimx)


# Your objective function to be minimized
estimation <- function(x) {

# Default values corresponds to scenarios 1

  
  
N0 =x[1]
Nanc=x[2]
NPAST <-  Nanc/N0
TCHANGE <- x[3] # a revoir peut être

THETA <- 1

model <- coal_model(sample_size = 100,loci_number = 1000,loci_length = 1000,ploidy = 2)
model <- model <- model + feat_mutation(rate = THETA)
model <- model + feat_size_change(new_size = NPAST,time = TCHANGE,population = "all")
model <- model +
  sumstat_tajimas_d(name = "Dtaj") +
  sumstat_nucleotide_div(name = "pi") +
  sumstat_sfs(name="sfs") +
  sumstat_trees(name="trees")
sim <- simulate(model)

mean_pi <- mean(sim$pi)
se_pi <- sd(sim$pi)/sqrt(NLOCI)
mean_Dtaj <- mean(sim$Dtaj,na.rm = T) # Dtaj is not defined if there is no SNPs
se_Dtaj <- var(sim$Dtaj,na.rm = T)/sqrt(NLOCI)


  # Création d'un dataframe pour ggplot2
simu <- data.frame(mean_pi = mean(sim$pi), 
                 se_pi = sd(sim$pi)/sqrt(NLOCI), 
                 mean_Dtaj = mean(sim$Dtaj,na.rm = T), 
                 se_Dtaj = var(sim$Dtaj,na.rm = T)/sqrt(NLOCI))

  # Compare obs and simu
  dist = sum((obs[,c("mean_pi", "se_pi", "mean_Dtaj", "se_Dtaj")] - 
                simu[,c("mean_pi", "se_pi", "mean_Dtaj", "se_Dtaj")])^2)
  return(dist)
}




# Rappel: 
## Scénario 1

# Une population ancestrale de taille $N_{anc}=10 000$ qui passe à $N_0=50 000$ 10 000 générations dans le passé.

#N0 =x[1]
#Nanc=x[2]
#NPAST <-  Nanc/N0
#TCHANGE <- x[3] # a revoir peut être

# Initial guess
initial_guess <- c(50000, 10000, 0.1)  # Replace with your own initial values

estimation(initial_guess)

df_stock <- data.frame(NO = character(), 
                 Nanc = character(), 
                 TCHANGE = character(), 
                 
                 dist= character())
start_time100 <- Sys.time()

for (i in c(1:100)) {
  NO <- runif(n = 1,min = 1000,max = 100000)
  Nanc <- runif(n = 1,min = 1000,max = 100000)
  TCHANGE <- runif(n = 1,min = 0,max = 1) 
  
  valeurs=c(NO,Nanc,TCHANGE)
  
  df_i=data.frame(NO = NO, 
                 Nanc = Nanc, 
                 TCHANGE = TCHANGE, 
                 dist= estimation(valeurs))
  
  df_stock=rbind(df_stock,df_i)
}

end_time100 <- Sys.time() 
execution_time <- end_time100 - start_time100; execution_time

library(dplyr)
library(ggplot2)
library(tidyr)
library(GGally)

df <- df_stock %>% arrange(dist)
top_100 <- head(df, 50)

ggpairs(top_100[,1:3])

for (i in 1:3){ 
plot(density(top_100[,i], na.rm = TRUE), 
      main = paste0("Distribution de :",i ))
}


```

```{r}
# Avec FAST

# Bornes des intervalles d’incertitude (lois uniformes)

borne_para <- apply(matrix_para,
                     2,
                     function(x) {
                       list(mean = mean(x), sd = sd(x))
                     })



# QUESTION b: Cas a 100 scenario
start_time100 <- Sys.time()

fast100 <- fast99(model=NULL,
                      factors=nom,
                      n=100,
                      q=rep("qnorm",15),
                      q.arg=borne_para)


end_time100 <- Sys.time() 
execution_time <- end_time100 - start_time100
execution_time
```

