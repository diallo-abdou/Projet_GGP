---
title: "parti abc"
author: "Abdou, Antoine et Youna"
date: "2023-12-10"
output: html_document
---

```{r}
estimation <- function(x,obs_donnee) {
# Default values corresponds to scenarios 1

NPAST <- x[1]  
TCHANGE <- x[2] 
THETA <- 1

model <- coal_model(sample_size = 20,loci_number = 100,loci_length = 100,ploidy = 2)
model <- model <- model + feat_mutation(rate = THETA)
model <- model + feat_size_change(new_size = NPAST,time = TCHANGE,population = "all")
model <- model +
  sumstat_tajimas_d(name = "Dtaj") +
  sumstat_nucleotide_div(name = "pi")
sim <- simulate(model)

mean_pi <- mean(sim$pi)
#se_pi <- sd(sim$pi)/sqrt(NLOCI)
mean_Dtaj <- mean(sim$Dtaj,na.rm = T) # Dtaj is not defined if there is no SNPs
#se_Dtaj <- var(sim$Dtaj,na.rm = T)/sqrt(NLOCI)

  # Création d'un dataframe pour ggplot2
simu <- data.frame(mean_pi = mean(sim$pi), 
                 mean_Dtaj = mean(sim$Dtaj,na.rm = T))

  # Compare obs and simu
dist= sqrt ( sum  (   ( obs_donnee[,c("mean_pi", "mean_Dtaj")] / 
                          simu[,c("mean_pi", "mean_Dtaj")]  - 1 )^2)    )

  return(dist)
}

#initial_guess <- c(0.2, 0.1)  # Replace with your own initial values
#estimation(initial_guess,tot_obs[1,])

# une liste pour stocker les df des simu

top_1000_df <- list()
n_iteration=10000
start_time100 <- Sys.time()

for (num_obs in 3:3) { 
# stock des estimations
df_stock <- data.frame( 
                 Nanc = character(), 
                 TCHANGE = character(), 
                 dist= character())
# simulation
for (i in 1:n_iteration) {
  Nanc <- runif(n = 1,min = 1,max = 5)
  TCHANGE <- runif(n = 1,min = 1,max = 5) 
  valeurs=c(Nanc,TCHANGE)
  df_i=data.frame(
                 Nanc = Nanc, 
                 TCHANGE = TCHANGE, 
                 dist= estimation(valeurs,tot_obs[num_obs,]))
  df_stock=rbind(df_stock,df_i)
}

df <- df_stock %>% arrange(dist)
top_100 <- head(df, 100)
top_1000_df[[paste0("estima_avec_obs_", num_obs)]] <- top_100

message("Iteration: ", num_obs, " sur ", nrow(tot_obs))
}

end_time100 <- Sys.time() 
execution_time <- end_time100 - start_time100; execution_time

top_1000_df



# on combine tous les top 100 
all_top_1000<- data.frame(
  Nanc = character(),
  TCHANGE = character(),
  dist = character()
)
# VALIDITE on stock la moyenne de chaque top 100
sctoc=data.frame(moy_Nanc=character(),
                 moy_TCHANGE=character(),
                 moy_dis=character()
                 )
for (k in 1:nrow(tot_obs)) {
  nom_df = paste0("estima_avec_obs_", k)
  all_top_1000 <- rbind(all_top_1000, top_1000_df[[nom_df]] )
  
  
  # validité
  moy= data.frame(moy_Nanc=top_1000_df[[nom_df]][,1],
                 moy_TCHANGE=top_1000_df[[nom_df]][,2],
                 moy_dis=top_1000_df[[nom_df]][,3]
                 )
  sctoc=rbind(sctoc, moy)
}

# 
all_top_1000_trie <- all_top_1000 %>% arrange(dist)
top_1000_1000 = head(all_top_1000_trie,100)
top_1000_1000
var(top_1000_1000$dist)
var(tot_obs$mean_pi)
var(tot_obs$mean_Dtaj)


# validité
hist(sctoc$moy_Nanc)
mean(sctoc$moy_Nanc)
sd(sctoc$moy_Nanc)




# rappel NPAST <- 0.2 , TCHANGE <- 0.1 

# graphiques
ggpairs(top_1000_1000[,1:2])
summary(top_1000_1000)

dens <- density(top_1000_1000[, 1], na.rm = TRUE)
plot(dens, main = paste0("Distribution de Nanc"))
abline(v = 0.2, col = "green", lty = 2)# barre verticale
lines(density(runif(10, min = 0.01, max = 5)), col = "red", lty = 3) # Prior
legend("topright", legend = c("Posterior","valeurs de base","Prior"), col = c("black","green","red"), lty = c(1,2,3))

dens <- density(top_1000_1000[, 2], na.rm = TRUE)
plot(dens, main = paste0("Distribution de TCHANGE"))
abline(v = 0.1, col = "green", lty = 2)# barre verticale
lines(density(runif(10, min = 0.01, max = 5)), col = "red", lty = 3) # Prior
legend("topright", legend = c("Posterior","valeurs de base","Prior"), col = c("black","green","red"), lty = c(1,2,3))



```
